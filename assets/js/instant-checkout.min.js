jQuery(function(o){"use strict";window.wc_sb_checkout={js_url:null,paymentMenu:null,isPaymentMenuLoaded:!1,xhr:!1,init:function(e){this.form=e,this.form_submit=!1,o(this.form).on("click","#place_order",{obj:window.wc_sb_checkout},this.onSubmit).on("submit checkout_place_order_payex_checkout"),o(document.body).bind("update_checkout",this.onUpdateCheckout),o(document.body).on("checkout_error",this.resetCheckout),o(document.body).on("updated_checkout",this.onUpdatedCheckout),o(document.body).on("blur",this.onUpdatedCheckout),wc_sb_common.isInstantCheckout()&&wc_sb_checkout.initInstantCheckout()},initInstantCheckout:function(){if(console.log("Initialization of Instant Checkout..."),wc_sb_common.isCheckinEnabled()){let e=o("#swedbank-pay-consumer-profile");if(e.length>0){let o=e.data("reference");console.log("Initiate consumerProfileRef",o)}}},initCheckout:function(e){o("#change-shipping-info").show(),wc_sb_checkout.form.find(".swedbank_pay_customer_reference").remove(),wc_sb_checkout.form.append("<input type='hidden' class='swedbank_pay_customer_reference' name='swedbank_pay_customer_reference' value='"+e+"'/>"),wc_sb_checkout.onSubmit({data:{obj:window.wc_sb_checkout}})},isPaymentMethodChosen:function(){return o("#payment_method_payex_checkout").is(":checked")},onClose:function(){wc_sb_common.unblock()},onReady:function(){console.log("Ready")},onUpdateCheckout:function(){if(console.log("onUpdateCheckout"),!wc_sb_common.isInstantCheckout())return!1},onUpdatedCheckout:function(){return console.log("onUpdatedCheckout"),!!wc_sb_common.isInstantCheckout()&&(!wc_sb_checkout.form.is(".processing")&&(wc_sb_common.validateForm()?(o(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),void wc_sb_checkout.updateOrder()):(console.log("onUpdatedCheckout: Validation is failed"),!1)))},onSubmit:function(n){var t=n.data.obj;let c=o("#terms");return c.length>0&&!c.prop("checked")?(t.submit_error('<div class="woocommerce-error">'+WC_Gateway_Swedbank_Pay_Checkout.terms_error+"</div>"),!1):!!t.form_submit||(!t.isPaymentMethodChosen()||("undefined"!=typeof e&&e.preventDefault(),wc_sb_common.validateForm()?(console.log("onSubmit"),!t.form.is(".processing")&&(o(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),t.form.addClass("processing"),wc_sb_common.block(),t.placeOrder().always(function(e){t.form.removeClass("processing"),wc_sb_common.unblock()}).fail(function(e,o){t.onError(o)}).done(function(e){if(console.log(e),"success"!==e.result)return e.hasOwnProperty("reload")&&!0===e.reload?void window.location.reload():(!0===e.result.refresh&&o(document.body).trigger("update_checkout"),void t.onError(e.messages));wc_sb_common.isRedirectMethodEnabled()?(console.log("Redirecting to "+e.redirect_url),window.location.href=e.redirect_url):(t.js_url=e.js_url,t.initPaymentJS(t.js_url))}),!1)):(console.log("The checkout form validation is failed."),wc_sb_common.isCheckinEnabled()&&t.submit_error('<div class="woocommerce-error">'+WC_Gateway_Swedbank_Pay_Checkout.checkin_error+"</div>"),!1)))},resetCheckout:function(){wc_sb_checkout.form_submit=!1},initPaymentJS:function(e,n){void 0===n&&(n=function(){}),window.hasOwnProperty("payex")&&window.payex.hasOwnProperty("hostedView")&&(void 0!==window.payex.hostedView.paymentMenu&&window.payex.hostedView.paymentMenu().close(),o("#payment-swedbank-pay-checkout iframe").remove()),o("script[src*='px.paymentmenu.client']").remove(),wc_sb_common.loadJs(e,function(){o("#payment-swedbank-pay-checkout iframe").remove(),wc_sb_common.isInstantCheckout()?(o("#payment").hide(),wc_sb_checkout.initPaymentMenu("payment-swedbank-pay-checkout")):(console.log("non-instant checkout"),o.featherlight('<div id="swedbank-pay-paymentmenu">&nbsp;</div>',{variant:"featherlight-swedbank-pay",persist:!0,closeOnClick:!1,closeOnEsc:!1,afterOpen:function(){wc_sb_checkout.initPaymentMenu("swedbank-pay-paymentmenu")},afterClose:function(){wc_sb_checkout.form.removeClass("processing").unblock()}})),n()})},initPaymentMenu:function(e,o){console.log("initPaymentMenu"),void 0===o&&(o=function(){}),this.paymentMenu=window.payex.hostedView.paymentMenu({container:e,culture:WC_Gateway_Swedbank_Pay_Checkout.culture,style:WC_Gateway_Swedbank_Pay_Checkout.paymentMenuStyle?JSON.parse(WC_Gateway_Swedbank_Pay_Checkout.paymentMenuStyle):null,onApplicationConfigured:function(e){console.log("onApplicationConfigured"),console.log(e),wc_sb_checkout.isPaymentMenuLoaded=!0,o(null)},onPaymentMenuInstrumentSelected:function(e){console.log("onPaymentMenuInstrumentSelected"),console.log(e),wc_sb_checkout.onPaymentMenuInstrumentSelected(e.name,e.instrument)},onPaymentCreated:function(){console.log("onPaymentCreated")},onPaymentCompleted:function(e){console.log("onPaymentCompleted"),console.log(e),self.location.href=e.redirectUrl},onPaymentCanceled:function(e){console.log("onPaymentCanceled"),console.log(e),wc_sb_common.logError("payment-menu-cancel",e)},onPaymentFailed:function(e){console.log("onPaymentFailed"),console.log(e),wc_sb_common.logError("payment-menu-failed",e)},onError:function(e){wc_sb_common.logError("payment-menu-error",e),o(e)}}),this.paymentMenu.open()},refreshPaymentMenu:function(){console.log("refreshPaymentMenu"),void 0!==this.paymentMenu&&this.paymentMenu&&(this.paymentMenu.hasOwnProperty("refresh")&&"function"==typeof this.paymentMenu.refresh?this.paymentMenu.refresh():console.warn("refreshPaymentMenu: paymentMenu doesn't support refresh"))},placeOrder:function(){console.log("placeOrder");let e=o(".woocommerce-checkout").serialize();return o.ajax({type:"POST",url:WC_Gateway_Swedbank_Pay_Checkout.ajax_url,data:{action:"swedbank_pay_place_order",nonce:WC_Gateway_Swedbank_Pay_Checkout.nonce,data:e},dataType:"json"}).done(function(e){e.hasOwnProperty("reload")&&!0===e.reload?window.location.reload():e.hasOwnProperty("result")&&"failure"===e.result&&(wc_sb_common.logError("sb-place-order",e),wc_sb_checkout.onError(e.messages))})},updateOrder:function(e){console.log("updateOrder");let n=o(".woocommerce-checkout").serialize();return void 0===e&&(e=!1),n+="&compatibility="+e,wc_sb_checkout.form.addClass("processing"),wc_sb_common.block(),wc_sb_checkout.xhr&&wc_sb_checkout.xhr.abort(),wc_sb_checkout.xhr=o.ajax({type:"POST",url:WC_Gateway_Swedbank_Pay_Checkout.ajax_url,data:{action:"swedbank_pay_update_order",nonce:WC_Gateway_Swedbank_Pay_Checkout.nonce,data:n},dataType:"json"}).always(function(e){wc_sb_checkout.xhr=!1,wc_sb_checkout.form.removeClass("processing"),wc_sb_common.unblock()}).fail(function(e,o){console.log("updateOrder error:"+o)}).done(function(n){if(console.log(n),n.hasOwnProperty("result")&&"success"===n.result)return wc_sb_checkout.js_url=n.js_url,void wc_sb_checkout.refreshPaymentMenu();if(n.hasOwnProperty("result")&&"failure"===n.result){if(""===n.messages)return void console.warn("Error message is empty.");if(n.messages.indexOf("Order update is not available.")>-1&&!e)return console.warn("refreshPaymentMenu: refresh workaround. Force reload."),void wc_sb_checkout.updateOrder(!0).done(function(e){e.hasOwnProperty("js_url")&&wc_sb_checkout.initPaymentJS(e.js_url)})}n.hasOwnProperty("reload")&&!0===n.reload?window.location.reload():(!0===n.result.refresh&&o(document.body).trigger("update_checkout"),wc_sb_common.logError("sb-update-order",n))}),wc_sb_checkout.xhr},onPaymentMenuInstrumentSelected:function(e,n){console.log("onPaymentMenuInstrumentSelected",e,n),o(document.body).trigger("sb_payment_menu_instrument_selected",[e,n])},onError:function(e){console.log("onError",e),wc_sb_checkout.submit_error('<div class="woocommerce-error">'+e+"</div>")},submit_error:function(e){o(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),wc_sb_checkout.form.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+e+"</div>"),wc_sb_checkout.form.removeClass("processing").unblock(),wc_sb_checkout.form.find(".input-text, select, input:checkbox").trigger("validate").blur(),wc_sb_checkout.scroll_to_notices(),o(document.body).trigger("checkout_error")},scroll_to_notices:function(){let e=o(".woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout");e.length||(e=o(".form.checkout")),o.scroll_to_notices(e)}},o(document).ready(function(){wc_sb_checkout.init(o("form.checkout, form#order_review, form#add_payment_method"))})});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluc3RhbnQtY2hlY2tvdXQuanMiXSwibmFtZXMiOlsialF1ZXJ5IiwiJCIsIndpbmRvdyIsIndjX3NiX2NoZWNrb3V0IiwianNfdXJsIiwicGF5bWVudE1lbnUiLCJpc1BheW1lbnRNZW51TG9hZGVkIiwieGhyIiwiaW5pdCIsImZvcm0iLCJ0aGlzIiwiZm9ybV9zdWJtaXQiLCJvbiIsIm9iaiIsIm9uU3VibWl0IiwiZG9jdW1lbnQiLCJib2R5IiwiYmluZCIsIm9uVXBkYXRlQ2hlY2tvdXQiLCJyZXNldENoZWNrb3V0Iiwib25VcGRhdGVkQ2hlY2tvdXQiLCJ3Y19zYl9jb21tb24iLCJpc0luc3RhbnRDaGVja291dCIsImluaXRJbnN0YW50Q2hlY2tvdXQiLCJjb25zb2xlIiwibG9nIiwiaXNDaGVja2luRW5hYmxlZCIsImNvbnN1bWVyUHJvZmlsZUVsbSIsImxlbmd0aCIsInJlZmVyZW5jZSIsImRhdGEiLCJpbml0Q2hlY2tvdXQiLCJzaG93IiwiZmluZCIsInJlbW92ZSIsImFwcGVuZCIsImlzUGF5bWVudE1ldGhvZENob3NlbiIsImlzIiwib25DbG9zZSIsInVuYmxvY2siLCJvblJlYWR5IiwidmFsaWRhdGVGb3JtIiwidXBkYXRlT3JkZXIiLCJldmVudCIsInNlbGYiLCJ0ZXJtcyIsInByb3AiLCJzdWJtaXRfZXJyb3IiLCJXQ19HYXRld2F5X1N3ZWRiYW5rX1BheV9DaGVja291dCIsInRlcm1zX2Vycm9yIiwiZSIsInByZXZlbnREZWZhdWx0IiwiYWRkQ2xhc3MiLCJibG9jayIsInBsYWNlT3JkZXIiLCJhbHdheXMiLCJyZXNwb25zZSIsInJlbW92ZUNsYXNzIiwiZmFpbCIsImpxWEhSIiwidGV4dFN0YXR1cyIsIm9uRXJyb3IiLCJkb25lIiwicmVzdWx0IiwiaGFzT3duUHJvcGVydHkiLCJyZWxvYWQiLCJsb2NhdGlvbiIsInJlZnJlc2giLCJ0cmlnZ2VyIiwibWVzc2FnZXMiLCJpc1JlZGlyZWN0TWV0aG9kRW5hYmxlZCIsImhyZWYiLCJpbml0UGF5bWVudEpTIiwiY2hlY2tpbl9lcnJvciIsInVybCIsImNhbGxiYWNrIiwicGF5ZXgiLCJob3N0ZWRWaWV3IiwiY2xvc2UiLCJsb2FkSnMiLCJoaWRlIiwiaW5pdFBheW1lbnRNZW51IiwiZmVhdGhlcmxpZ2h0IiwidmFyaWFudCIsInBlcnNpc3QiLCJjbG9zZU9uQ2xpY2siLCJjbG9zZU9uRXNjIiwiYWZ0ZXJPcGVuIiwiYWZ0ZXJDbG9zZSIsImlkIiwiY29udGFpbmVyIiwiY3VsdHVyZSIsInN0eWxlIiwicGF5bWVudE1lbnVTdHlsZSIsIkpTT04iLCJwYXJzZSIsIm9uQXBwbGljYXRpb25Db25maWd1cmVkIiwib25QYXltZW50TWVudUluc3RydW1lbnRTZWxlY3RlZCIsIm5hbWUiLCJpbnN0cnVtZW50Iiwib25QYXltZW50Q3JlYXRlZCIsIm9uUGF5bWVudENvbXBsZXRlZCIsInJlZGlyZWN0VXJsIiwib25QYXltZW50Q2FuY2VsZWQiLCJsb2dFcnJvciIsIm9uUGF5bWVudEZhaWxlZCIsIm9wZW4iLCJyZWZyZXNoUGF5bWVudE1lbnUiLCJ3YXJuIiwiZmllbGRzIiwic2VyaWFsaXplIiwiYWpheCIsInR5cGUiLCJhamF4X3VybCIsImFjdGlvbiIsIm5vbmNlIiwiZGF0YVR5cGUiLCJjb21wYXRpYmlsaXR5IiwiYWJvcnQiLCJpbmRleE9mIiwiZXJyb3JfbWVzc2FnZSIsInByZXBlbmQiLCJibHVyIiwic2Nyb2xsX3RvX25vdGljZXMiLCJzY3JvbGxFbGVtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiJBQUNBQSxPQUFRLFNBQVVDLEdBQ2QsYUFLQUMsT0FBT0MsZUFBaUIsQ0FDcEJDLE9BQVEsS0FDUkMsWUFBYSxLQUNiQyxxQkFBcUIsRUFDckJDLEtBQUssRUFLTEMsS0FBTSxTQUFVQyxHQUNaQyxLQUFLRCxLQUFlQSxFQUNwQkMsS0FBS0MsYUFBZSxFQUVwQlYsRUFBR1MsS0FBS0QsTUFHSEcsR0FBSSxRQUFTLGVBQWdCLENBQUNDLElBQU9YLE9BQU9DLGdCQUFpQk8sS0FBS0ksVUFHbEVG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MUJsRSxFQUFHYyxTQUFTQyxNQUFPb0QsUUFBUyxtQkFHaEMvQyxhQUFhbUYsU0FBVSxrQkFBbUJoRCxNQUl0Q3JELGVBQWVJLEtBUS9CMEYsZ0NBQWlDLFNBQVdDLEVBQU1DLEdBQzlDM0UsUUFBUUMsSUFBSyxrQ0FBbUN5RSxFQUFNQyxHQUN0RGxHLEVBQUdjLFNBQVNDLE1BQU9vRCxRQUFTLHNDQUF1QyxDQUFDOEIsRUFBTUMsS0FFOUV0QyxRQUFTLFNBQVcvQixHQUNoQk4sUUFBUUMsSUFBSyxVQUFXSyxHQUN4QjNCLGVBQWU0QyxhQUFjLGtDQUFvQ2pCLEVBQU8sV0FFNUVpQixhQUFjLFNBQVV5RSxHQUNwQnZILEVBQUcsK0VBQWdGaUMsU0FDbkYvQixlQUFlTSxLQUFLZ0gsUUFBUyx5RUFBMkVELEVBQWdCLFVBQ3hIckgsZUFBZU0sS0FBS2dELFlBQWEsY0FBZWxCLFVBQ2hEcEMsZUFBZU0sS0FBS3dCLEtBQU0sdUNBQXdDbUMsUUFBUyxZQUFhc0QsT0FDeEZ2SCxlQUFld0gsb0JBQ2YxSCxFQUFHYyxTQUFTQyxNQUFPb0QsUUFBUyxtQkFFaEN1RCxrQkFBbUIsV0FDZixJQUFJQyxFQUFnQjNILEVBQUcsaUZBQ2hCMkgsRUFBY2hHLFNBQ2pCZ0csRUFBZ0IzSCxFQUFHLG1CQUd2QkEsRUFBRTBILGtCQUFtQkMsS0FJN0IzSCxFQUFFYyxVQUFVOEcsTUFBTyxXQUNmMUgsZUFBZUssS0FBTVAsRUFBRyIsImZpbGUiOiJpbnN0YW50LWNoZWNrb3V0Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCB3Y19jaGVja291dF9wYXJhbXMgKi9cbmpRdWVyeSggZnVuY3Rpb24oICQgKSB7XG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgLyoqXG4gICAgICogT2JqZWN0IHRvIGhhbmRsZSBTd2VkYmFuayBQYXkgY2hlY2tvdXQgcGF5bWVudCBmb3Jtcy5cbiAgICAgKi9cbiAgICB3aW5kb3cud2Nfc2JfY2hlY2tvdXQgPSB7XG4gICAgICAgIGpzX3VybDogbnVsbCxcbiAgICAgICAgcGF5bWVudE1lbnU6IG51bGwsXG4gICAgICAgIGlzUGF5bWVudE1lbnVMb2FkZWQ6IGZhbHNlLFxuICAgICAgICB4aHI6IGZhbHNlLFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBJbml0aWFsaXplIGUgaGFuZGxlcnMgYW5kIFVJIHN0YXRlLlxuICAgICAgICAgKi9cbiAgICAgICAgaW5pdDogZnVuY3Rpb24oIGZvcm0gKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm0gICAgICAgICA9IGZvcm07XG4gICAgICAgICAgICB0aGlzLmZvcm1fc3VibWl0ICA9IGZhbHNlO1xuXG4gICAgICAgICAgICAkKCB0aGlzLmZvcm0gKVxuICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBiaW5kIGRpcmVjdGx5IHRvIHRoZSBjbGljayAoYW5kIG5vdCBjaGVja291dF9wbGFjZV9vcmRlcl9wYXlleF9jaGVja291dCkgdG8gYXZvaWQgcG9wdXAgYmxvY2tlcnNcbiAgICAgICAgICAgIC8vIGVzcGVjaWFsbHkgb24gbW9iaWxlIGRldmljZXMgKGxpa2Ugb24gQ2hyb21lIGZvciBpT1MpIGZyb20gYmxvY2tpbmcgcGF5ZXhfY2hlY2tvdXQocGF5bWVudF9pZCwge30sICdvcGVuJyk7IGZyb20gb3BlbmluZyBhIHRhYlxuICAgICAgICAgICAgICAgIC5vbiggJ2NsaWNrJywgJyNwbGFjZV9vcmRlcicsIHsnb2JqJzogd2luZG93LndjX3NiX2NoZWNrb3V0fSwgdGhpcy5vblN1Ym1pdCApXG5cbiAgICAgICAgICAgICAgICAvLyBXb29Db21tZXJjZSBsZXRzIHVzIHJldHVybiBhIGZhbHNlIG9uIGNoZWNrb3V0X3BsYWNlX29yZGVyX3tnYXRld2F5fSB0byBrZWVwIHRoZSBmb3JtIGZyb20gc3VibWl0dGluZ1xuICAgICAgICAgICAgICAgIC5vbiggJ3N1Ym1pdCBjaGVja291dF9wbGFjZV9vcmRlcl9wYXlleF9jaGVja291dCcgKTtcblxuICAgICAgICAgICAgJCggZG9jdW1lbnQuYm9keSApLmJpbmQoICd1cGRhdGVfY2hlY2tvdXQnLCB0aGlzLm9uVXBkYXRlQ2hlY2tvdXQgKTtcbiAgICAgICAgICAgICQoIGRvY3VtZW50LmJvZHkgKS5vbiggJ2NoZWNrb3V0X2Vycm9yJywgdGhpcy5yZXNldENoZWNrb3V0ICk7XG4gICAgICAgICAgICAkKCBkb2N1bWVudC5ib2R5ICkub24oICd1cGRhdGVkX2NoZWNrb3V0JywgdGhpcy5vblVwZGF0ZWRDaGVja291dCApO1xuICAgICAgICAgICAgJCggZG9jdW1lbnQuYm9keSApLm9uKCAnYmx1cicsIHRoaXMub25VcGRhdGVkQ2hlY2tvdXQgKTtcblxuICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBJbnN0YW50IENoZWNrb3V0XG4gICAgICAgICAgICBpZiAoIHdjX3NiX2NvbW1vbi5pc0luc3RhbnRDaGVja291dCgpICkge1xuICAgICAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LmluaXRJbnN0YW50Q2hlY2tvdXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICAvKipcbiAgICAgICAgICogSW5pdGlhbGl6ZSBJbnN0YW50IENoZWNrb3V0XG4gICAgICAgICAqL1xuICAgICAgICBpbml0SW5zdGFudENoZWNrb3V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyggJ0luaXRpYWxpemF0aW9uIG9mIEluc3RhbnQgQ2hlY2tvdXQuLi4nICk7XG5cbiAgICAgICAgICAgIGlmICggd2Nfc2JfY29tbW9uLmlzQ2hlY2tpbkVuYWJsZWQoKSApIHtcbiAgICAgICAgICAgICAgICAvLyBVc2Ugc2F2ZWQgY29uc3VtZXJQcm9maWxlUmVmXG4gICAgICAgICAgICAgICAgbGV0IGNvbnN1bWVyUHJvZmlsZUVsbSA9ICQoICcjc3dlZGJhbmstcGF5LWNvbnN1bWVyLXByb2ZpbGUnICk7XG4gICAgICAgICAgICAgICAgaWYgKCBjb25zdW1lclByb2ZpbGVFbG0ubGVuZ3RoID4gMCApIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlZmVyZW5jZSA9IGNvbnN1bWVyUHJvZmlsZUVsbS5kYXRhKCAncmVmZXJlbmNlJyApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyggJ0luaXRpYXRlIGNvbnN1bWVyUHJvZmlsZVJlZicsIHJlZmVyZW5jZSApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICBpbml0Q2hlY2tvdXQ6IGZ1bmN0aW9uKCByZWZlcmVuY2UgKSB7XG4gICAgICAgICAgICAvLyBTaG93IFwiQ2hhbmdlIHNoaXBwaW5nIGluZm9cIiBidXR0b25cbiAgICAgICAgICAgICQoICcjY2hhbmdlLXNoaXBwaW5nLWluZm8nICkuc2hvdygpO1xuXG4gICAgICAgICAgICB3Y19zYl9jaGVja291dC5mb3JtLmZpbmQoICcuc3dlZGJhbmtfcGF5X2N1c3RvbWVyX3JlZmVyZW5jZScgKS5yZW1vdmUoKTtcbiAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LmZvcm0uYXBwZW5kKCBcIjxpbnB1dCB0eXBlPSdoaWRkZW4nIGNsYXNzPSdzd2VkYmFua19wYXlfY3VzdG9tZXJfcmVmZXJlbmNlJyBuYW1lPSdzd2VkYmFua19wYXlfY3VzdG9tZXJfcmVmZXJlbmNlJyB2YWx1ZT0nXCIgKyByZWZlcmVuY2UgKyBcIicvPlwiICk7XG4gICAgICAgICAgICB3Y19zYl9jaGVja291dC5vblN1Ym1pdChcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iajogd2luZG93LndjX3NiX2NoZWNrb3V0XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgaXNQYXltZW50TWV0aG9kQ2hvc2VuOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiAkKCAnI3BheW1lbnRfbWV0aG9kX3BheWV4X2NoZWNrb3V0JyApLmlzKCAnOmNoZWNrZWQnICk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgb25DbG9zZTogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB3Y19zYl9jb21tb24udW5ibG9jaygpO1xuICAgICAgICB9LFxuXG4gICAgICAgIG9uUmVhZHk6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coICdSZWFkeScgKTtcbiAgICAgICAgfSxcblxuICAgICAgICBvblVwZGF0ZUNoZWNrb3V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCAnb25VcGRhdGVDaGVja291dCcgKTtcblxuICAgICAgICAgICAgaWYgKCAhIHdjX3NiX2NvbW1vbi5pc0luc3RhbnRDaGVja291dCgpICkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gQHRvZG9cbiAgICAgICAgfSxcblxuICAgICAgICBvblVwZGF0ZWRDaGVja291dDogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyggJ29uVXBkYXRlZENoZWNrb3V0JyApO1xuXG4gICAgICAgICAgICBpZiAoICEgd2Nfc2JfY29tbW9uLmlzSW5zdGFudENoZWNrb3V0KCkgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIHdjX3NiX2NoZWNrb3V0LmZvcm0uaXMoICcucHJvY2Vzc2luZycgKSApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICggISB3Y19zYl9jb21tb24udmFsaWRhdGVGb3JtKCkgKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coICdvblVwZGF0ZWRDaGVja291dDogVmFsaWRhdGlvbiBpcyBmYWlsZWQnICk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAkKCAnLndvb2NvbW1lcmNlLU5vdGljZUdyb3VwLWNoZWNrb3V0LCAud29vY29tbWVyY2UtZXJyb3IsIC53b29jb21tZXJjZS1tZXNzYWdlJyApLnJlbW92ZSgpO1xuICAgICAgICAgICAgd2Nfc2JfY2hlY2tvdXQudXBkYXRlT3JkZXIoKTtcbiAgICAgICAgfSxcblxuICAgICAgICBvblN1Ym1pdDogZnVuY3Rpb24oIGV2ZW50ICkge1xuICAgICAgICAgICAgdmFyIHNlbGYgPSBldmVudC5kYXRhLm9iajtcbiAgICAgICAgICAgIGxldCB0ZXJtcyA9ICQoICcjdGVybXMnICk7XG5cbiAgICAgICAgICAgIC8vIFZhbGlkYXRlIFwidGVybXMgYW5kIGNvbmRpdGlvbnNcIiBpZiBleGlzdHNcbiAgICAgICAgICAgIGlmICggdGVybXMubGVuZ3RoID4gMCAmJiAhIHRlcm1zLnByb3AoICdjaGVja2VkJyApICkge1xuICAgICAgICAgICAgICAgIHNlbGYuc3VibWl0X2Vycm9yKCAnPGRpdiBjbGFzcz1cIndvb2NvbW1lcmNlLWVycm9yXCI+JyArIFdDX0dhdGV3YXlfU3dlZGJhbmtfUGF5X0NoZWNrb3V0LnRlcm1zX2Vycm9yICsgJzwvZGl2PicgKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICggc2VsZi5mb3JtX3N1Ym1pdCApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCBzZWxmLmlzUGF5bWVudE1ldGhvZENob3NlbigpICkge1xuICAgICAgICAgICAgICAgIGlmICggdHlwZW9mIGUgIT09ICd1bmRlZmluZWQnICkge1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCAhIHdjX3NiX2NvbW1vbi52YWxpZGF0ZUZvcm0oKSApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coICdUaGUgY2hlY2tvdXQgZm9ybSB2YWxpZGF0aW9uIGlzIGZhaWxlZC4nICk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCB3Y19zYl9jb21tb24uaXNDaGVja2luRW5hYmxlZCgpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zdWJtaXRfZXJyb3IoICc8ZGl2IGNsYXNzPVwid29vY29tbWVyY2UtZXJyb3JcIj4nICsgV0NfR2F0ZXdheV9Td2VkYmFua19QYXlfQ2hlY2tvdXQuY2hlY2tpbl9lcnJvciArICc8L2Rpdj4nICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coICdvblN1Ym1pdCcgKTtcblxuICAgICAgICAgICAgICAgIGlmICggc2VsZi5mb3JtLmlzKCAnLnByb2Nlc3NpbmcnICkgKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAkKCAnLndvb2NvbW1lcmNlLU5vdGljZUdyb3VwLWNoZWNrb3V0LCAud29vY29tbWVyY2UtZXJyb3IsIC53b29jb21tZXJjZS1tZXNzYWdlJyApLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIHNlbGYuZm9ybS5hZGRDbGFzcyggJ3Byb2Nlc3NpbmcnICk7XG4gICAgICAgICAgICAgICAgd2Nfc2JfY29tbW9uLmJsb2NrKCk7XG4gICAgICAgICAgICAgICAgc2VsZi5wbGFjZU9yZGVyKClcbiAgICAgICAgICAgICAgICAgICAgLmFsd2F5cyggZnVuY3Rpb24gKCByZXNwb25zZSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZm9ybS5yZW1vdmVDbGFzcyggJ3Byb2Nlc3NpbmcnICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB3Y19zYl9jb21tb24udW5ibG9jaygpO1xuICAgICAgICAgICAgICAgICAgICB9IClcbiAgICAgICAgICAgICAgICAgICAgLmZhaWwoIGZ1bmN0aW9uKCBqcVhIUiwgdGV4dFN0YXR1cyApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub25FcnJvciggdGV4dFN0YXR1cyApO1xuICAgICAgICAgICAgICAgICAgICB9IClcbiAgICAgICAgICAgICAgICAgICAgLmRvbmUoIGZ1bmN0aW9uICggcmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCByZXNwb25zZSApO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCByZXNwb25zZS5yZXN1bHQgIT09ICdzdWNjZXNzJyApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWxvYWQgcGFnZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggcmVzcG9uc2UuaGFzT3duUHJvcGVydHkoJ3JlbG9hZCcpICYmIHRydWUgPT09IHJlc3BvbnNlLnJlbG9hZCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciB1cGRhdGUgaW4gY2FzZSB3ZSBuZWVkIGEgZnJlc2ggbm9uY2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHRydWUgPT09IHJlc3BvbnNlLnJlc3VsdC5yZWZyZXNoICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCBkb2N1bWVudC5ib2R5ICkudHJpZ2dlciggJ3VwZGF0ZV9jaGVja291dCcgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm9uRXJyb3IoIHJlc3BvbnNlLm1lc3NhZ2VzICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHdjX3NiX2NvbW1vbi5pc1JlZGlyZWN0TWV0aG9kRW5hYmxlZCgpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZGlyZWN0IHRvIHRoZSBwYXltZW50IGdhdGV3YXkgcGFnZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCAnUmVkaXJlY3RpbmcgdG8gJyArIHJlc3BvbnNlWydyZWRpcmVjdF91cmwnXSApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gcmVzcG9uc2VbJ3JlZGlyZWN0X3VybCddO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIFN3ZWRCYW5rIFBheSBDaGVja291dCBmcmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuanNfdXJsID0gcmVzcG9uc2VbJ2pzX3VybCddO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdFBheW1lbnRKUyggc2VsZi5qc191cmwgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSApO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSxcblxuICAgICAgICByZXNldENoZWNrb3V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LmZvcm1fc3VibWl0ID0gZmFsc2U7XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEluaXRpYXRlIFBheW1lbnQgSmF2YXNjcmlwdFxuICAgICAgICAgKiBAcGFyYW0gdXJsXG4gICAgICAgICAqIEBwYXJhbSBjYWxsYmFja1xuICAgICAgICAgKi9cbiAgICAgICAgaW5pdFBheW1lbnRKUzogZnVuY3Rpb24gKCB1cmwsIGNhbGxiYWNrICkge1xuICAgICAgICAgICAgaWYgKCB0eXBlb2YgY2FsbGJhY2sgPT09ICd1bmRlZmluZWQnICkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gKCkge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIERlc3Ryb3lcbiAgICAgICAgICAgIGlmICggd2luZG93Lmhhc093blByb3BlcnR5KCAncGF5ZXgnICkgJiYgd2luZG93LnBheWV4Lmhhc093blByb3BlcnR5KCAnaG9zdGVkVmlldycgKSApIHtcbiAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZiB3aW5kb3cucGF5ZXguaG9zdGVkVmlldy5wYXltZW50TWVudSAhPT0gJ3VuZGVmaW5lZCcgKSB7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5wYXlleC5ob3N0ZWRWaWV3LnBheW1lbnRNZW51KCkuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAkKCAnI3BheW1lbnQtc3dlZGJhbmstcGF5LWNoZWNrb3V0IGlmcmFtZScgKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAvL2RlbGV0ZSB3aW5kb3cucGF5ZXguaG9zdGVkVmlldztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gRGVzdHJveSBKU1xuICAgICAgICAgICAgJCggXCJzY3JpcHRbc3JjKj0ncHgucGF5bWVudG1lbnUuY2xpZW50J11cIiApLnJlbW92ZSgpO1xuXG4gICAgICAgICAgICAvLyBMb2FkIEpTXG4gICAgICAgICAgICB3Y19zYl9jb21tb24ubG9hZEpzKCB1cmwsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAkKCAnI3BheW1lbnQtc3dlZGJhbmstcGF5LWNoZWNrb3V0IGlmcmFtZScgKS5yZW1vdmUoKTtcblxuICAgICAgICAgICAgICAgIC8vIExvYWQgU3dlZEJhbmsgUGF5IENoZWNrb3V0IGZyYW1lXG4gICAgICAgICAgICAgICAgaWYgKCB3Y19zYl9jb21tb24uaXNJbnN0YW50Q2hlY2tvdXQoKSApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gSW5pdGlhdGUgdGhlIHBheW1lbnQgbWVudSBpbiBcIkluc3RhbnQgQ2hlY2tvdXRcIlxuICAgICAgICAgICAgICAgICAgICAkKCAnI3BheW1lbnQnICkuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICB3Y19zYl9jaGVja291dC5pbml0UGF5bWVudE1lbnUoICdwYXltZW50LXN3ZWRiYW5rLXBheS1jaGVja291dCcgKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBJbml0aWF0ZSB0aGUgcGF5bWVudCBtZW51IGluIHRoZSBmcmFtZVxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyggJ25vbi1pbnN0YW50IGNoZWNrb3V0JyApO1xuICAgICAgICAgICAgICAgICAgICAkLmZlYXRoZXJsaWdodCggJzxkaXYgaWQ9XCJzd2VkYmFuay1wYXktcGF5bWVudG1lbnVcIj4mbmJzcDs8L2Rpdj4nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXJpYW50OiAnZmVhdGhlcmxpZ2h0LXN3ZWRiYW5rLXBheScsXG4gICAgICAgICAgICAgICAgICAgICAgICBwZXJzaXN0OiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VPbkNsaWNrOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlT25Fc2M6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJPcGVuOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2Nfc2JfY2hlY2tvdXQuaW5pdFBheW1lbnRNZW51KCAnc3dlZGJhbmstcGF5LXBheW1lbnRtZW51JyApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyQ2xvc2U6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3Y19zYl9jaGVja291dC5mb3JtLnJlbW92ZUNsYXNzKCAncHJvY2Vzc2luZycgKS51bmJsb2NrKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpXG4gICAgICAgICAgICB9ICk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEluaXRpYXRlIFBheW1lbnQgTWVudS5cbiAgICAgICAgICogUGF5bWVudCBKYXZhc2NyaXB0IG11c3QgYmUgbG9hZGVkLlxuICAgICAgICAgKlxuICAgICAgICAgKiBAcGFyYW0gaWRcbiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrXG4gICAgICAgICAqL1xuICAgICAgICBpbml0UGF5bWVudE1lbnU6IGZ1bmN0aW9uICggaWQsIGNhbGxiYWNrICkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coICdpbml0UGF5bWVudE1lbnUnICk7XG5cbiAgICAgICAgICAgIGlmICggdHlwZW9mIGNhbGxiYWNrID09PSAndW5kZWZpbmVkJyApIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBMb2FkIFN3ZWRCYW5rIFBheSBDaGVja291dCBmcmFtZVxuICAgICAgICAgICAgdGhpcy5wYXltZW50TWVudSA9IHdpbmRvdy5wYXlleC5ob3N0ZWRWaWV3LnBheW1lbnRNZW51KCB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyOiBpZCxcbiAgICAgICAgICAgICAgICBjdWx0dXJlOiBXQ19HYXRld2F5X1N3ZWRiYW5rX1BheV9DaGVja291dC5jdWx0dXJlLFxuICAgICAgICAgICAgICAgIHN0eWxlOiBXQ19HYXRld2F5X1N3ZWRiYW5rX1BheV9DaGVja291dC5wYXltZW50TWVudVN0eWxlID8gSlNPTi5wYXJzZSggV0NfR2F0ZXdheV9Td2VkYmFua19QYXlfQ2hlY2tvdXQucGF5bWVudE1lbnVTdHlsZSApIDogbnVsbCxcbiAgICAgICAgICAgICAgICBvbkFwcGxpY2F0aW9uQ29uZmlndXJlZDogZnVuY3Rpb24oIGRhdGEgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCAnb25BcHBsaWNhdGlvbkNvbmZpZ3VyZWQnICk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCBkYXRhICk7XG4gICAgICAgICAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LmlzUGF5bWVudE1lbnVMb2FkZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayggbnVsbCApO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb25QYXltZW50TWVudUluc3RydW1lbnRTZWxlY3RlZDogZnVuY3Rpb24gKCBkYXRhICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyggJ29uUGF5bWVudE1lbnVJbnN0cnVtZW50U2VsZWN0ZWQnICk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCBkYXRhICk7XG4gICAgICAgICAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0Lm9uUGF5bWVudE1lbnVJbnN0cnVtZW50U2VsZWN0ZWQoIGRhdGEubmFtZSwgZGF0YS5pbnN0cnVtZW50ICk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBvblBheW1lbnRDcmVhdGVkOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCAnb25QYXltZW50Q3JlYXRlZCcgKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG9uUGF5bWVudENvbXBsZXRlZDogZnVuY3Rpb24gKCBkYXRhICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyggJ29uUGF5bWVudENvbXBsZXRlZCcgKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIGRhdGEgKTtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2NhdGlvbi5ocmVmID0gZGF0YS5yZWRpcmVjdFVybDtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG9uUGF5bWVudENhbmNlbGVkOiBmdW5jdGlvbiAoIGRhdGEgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCAnb25QYXltZW50Q2FuY2VsZWQnICk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCBkYXRhICk7XG4gICAgICAgICAgICAgICAgICAgIHdjX3NiX2NvbW1vbi5sb2dFcnJvciggJ3BheW1lbnQtbWVudS1jYW5jZWwnLCBkYXRhICk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBvblBheW1lbnRGYWlsZWQ6IGZ1bmN0aW9uICggZGF0YSApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coICdvblBheW1lbnRGYWlsZWQnICk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCBkYXRhICk7XG4gICAgICAgICAgICAgICAgICAgIHdjX3NiX2NvbW1vbi5sb2dFcnJvciggJ3BheW1lbnQtbWVudS1mYWlsZWQnLCBkYXRhICk7XG4gICAgICAgICAgICAgICAgICAgIC8vc2VsZi5sb2NhdGlvbi5ocmVmID0gZGF0YS5yZWRpcmVjdFVybDtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG9uRXJyb3I6IGZ1bmN0aW9uICggZGF0YSApIHtcbiAgICAgICAgICAgICAgICAgICAgd2Nfc2JfY29tbW9uLmxvZ0Vycm9yKCAncGF5bWVudC1tZW51LWVycm9yJywgZGF0YSApO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayggZGF0YSApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gKTtcblxuICAgICAgICAgICAgdGhpcy5wYXltZW50TWVudS5vcGVuKCk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJlZnJlc2hcbiAgICAgICAgICovXG4gICAgICAgIHJlZnJlc2hQYXltZW50TWVudTogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyggJ3JlZnJlc2hQYXltZW50TWVudScgKTtcbiAgICAgICAgICAgIGlmICggdHlwZW9mIHRoaXMucGF5bWVudE1lbnUgIT09ICd1bmRlZmluZWQnICYmIHRoaXMucGF5bWVudE1lbnUgKSB7XG4gICAgICAgICAgICAgICAgaWYgKCB0aGlzLnBheW1lbnRNZW51Lmhhc093blByb3BlcnR5KCAncmVmcmVzaCcgKSAmJiB0eXBlb2YgdGhpcy5wYXltZW50TWVudS5yZWZyZXNoID09PSAnZnVuY3Rpb24nICkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBheW1lbnRNZW51LnJlZnJlc2goKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oICdyZWZyZXNoUGF5bWVudE1lbnU6IHBheW1lbnRNZW51IGRvZXNuXFwndCBzdXBwb3J0IHJlZnJlc2gnICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBQbGFjZSBPcmRlclxuICAgICAgICAgKiBAcmV0dXJuIHtKUXVlcnlQcm9taXNlPGFueT59XG4gICAgICAgICAqL1xuICAgICAgICBwbGFjZU9yZGVyOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyggJ3BsYWNlT3JkZXInICk7XG4gICAgICAgICAgICBsZXQgZmllbGRzID0gJCgnLndvb2NvbW1lcmNlLWNoZWNrb3V0Jykuc2VyaWFsaXplKCk7XG5cbiAgICAgICAgICAgIHJldHVybiAkLmFqYXgoIHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnUE9TVCcsXG4gICAgICAgICAgICAgICAgdXJsOiBXQ19HYXRld2F5X1N3ZWRiYW5rX1BheV9DaGVja291dC5hamF4X3VybCxcbiAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ3N3ZWRiYW5rX3BheV9wbGFjZV9vcmRlcicsXG4gICAgICAgICAgICAgICAgICAgIG5vbmNlOiBXQ19HYXRld2F5X1N3ZWRiYW5rX1BheV9DaGVja291dC5ub25jZSxcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogZmllbGRzXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nXG4gICAgICAgICAgICB9ICkuZG9uZSggZnVuY3Rpb24gKCByZXNwb25zZSApIHtcbiAgICAgICAgICAgICAgICAvLyBSZWxvYWQgcGFnZVxuICAgICAgICAgICAgICAgIGlmICggcmVzcG9uc2UuaGFzT3duUHJvcGVydHkoJ3JlbG9hZCcpICYmIHRydWUgPT09IHJlc3BvbnNlLnJlbG9hZCApIHtcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICBcdFx0fVxuXG4gICAgICAgICAgICAgICAgaWYgKCByZXNwb25zZS5oYXNPd25Qcm9wZXJ0eSgncmVzdWx0JykgJiYgcmVzcG9uc2UucmVzdWx0ID09PSAnZmFpbHVyZScgKSB7XG4gICAgICAgICAgICAgICAgICAgIHdjX3NiX2NvbW1vbi5sb2dFcnJvciggJ3NiLXBsYWNlLW9yZGVyJywgcmVzcG9uc2UgKTtcbiAgICAgICAgICAgICAgICAgICAgd2Nfc2JfY2hlY2tvdXQub25FcnJvciggcmVzcG9uc2UubWVzc2FnZXMgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ICk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVwZGF0ZSBPcmRlclxuICAgICAgICAgKiBAcGFyYW0gY29tcGF0aWJpbGl0eVxuICAgICAgICAgKiBAcmV0dXJuIHtKUXVlcnlQcm9taXNlPGFueT59XG4gICAgICAgICAqL1xuICAgICAgICB1cGRhdGVPcmRlcjogZnVuY3Rpb24gKCBjb21wYXRpYmlsaXR5ICkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coICd1cGRhdGVPcmRlcicgKTtcbiAgICAgICAgICAgIGxldCBmaWVsZHMgPSAkKCcud29vY29tbWVyY2UtY2hlY2tvdXQnKS5zZXJpYWxpemUoKTtcblxuICAgICAgICAgICAgaWYgKCB0eXBlb2YgY29tcGF0aWJpbGl0eSA9PT0gJ3VuZGVmaW5lZCcgKSB7XG4gICAgICAgICAgICAgICAgY29tcGF0aWJpbGl0eSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmaWVsZHMgKz0gJyZjb21wYXRpYmlsaXR5PScgKyBjb21wYXRpYmlsaXR5O1xuXG4gICAgICAgICAgICB3Y19zYl9jaGVja291dC5mb3JtLmFkZENsYXNzKCAncHJvY2Vzc2luZycgKTtcbiAgICAgICAgICAgIHdjX3NiX2NvbW1vbi5ibG9jaygpO1xuXG4gICAgICAgICAgICBpZiAoIHdjX3NiX2NoZWNrb3V0LnhociApIHtcbiAgICAgICAgICAgICAgICB3Y19zYl9jaGVja291dC54aHIuYWJvcnQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgd2Nfc2JfY2hlY2tvdXQueGhyID0gJC5hamF4KCB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLFxuICAgICAgICAgICAgICAgIHVybDogV0NfR2F0ZXdheV9Td2VkYmFua19QYXlfQ2hlY2tvdXQuYWpheF91cmwsXG4gICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdzd2VkYmFua19wYXlfdXBkYXRlX29yZGVyJyxcbiAgICAgICAgICAgICAgICAgICAgbm9uY2U6IFdDX0dhdGV3YXlfU3dlZGJhbmtfUGF5X0NoZWNrb3V0Lm5vbmNlLFxuICAgICAgICAgICAgICAgICAgICBkYXRhOiBmaWVsZHNcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbidcbiAgICAgICAgICAgIH0gKVxuICAgICAgICAgICAgICAgIC5hbHdheXMoIGZ1bmN0aW9uICggcmVzcG9uc2UgKSB7XG4gICAgICAgICAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LnhociA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB3Y19zYl9jaGVja291dC5mb3JtLnJlbW92ZUNsYXNzKCAncHJvY2Vzc2luZycgKTtcbiAgICAgICAgICAgICAgICAgICAgd2Nfc2JfY29tbW9uLnVuYmxvY2soKTtcbiAgICAgICAgICAgICAgICB9IClcbiAgICAgICAgICAgICAgICAuZmFpbCggZnVuY3Rpb24oIGpxWEhSLCB0ZXh0U3RhdHVzICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyggJ3VwZGF0ZU9yZGVyIGVycm9yOicgKyB0ZXh0U3RhdHVzICk7XG4gICAgICAgICAgICAgICAgICAgIC8vd2Nfc2JfY2hlY2tvdXQub25FcnJvciggdGV4dFN0YXR1cyApO1xuICAgICAgICAgICAgICAgIH0gKVxuICAgICAgICAgICAgICAgIC5kb25lKCBmdW5jdGlvbiAoIHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCByZXNwb25zZSApO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICggcmVzcG9uc2UuaGFzT3duUHJvcGVydHkoJ3Jlc3VsdCcpICYmIHJlc3BvbnNlLnJlc3VsdCA9PT0gJ3N1Y2Nlc3MnICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmcmVzaCBQYXltZW50IE1lbnVcbiAgICAgICAgICAgICAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LmpzX3VybCA9IHJlc3BvbnNlWydqc191cmwnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LnJlZnJlc2hQYXltZW50TWVudSgpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoIHJlc3BvbnNlLmhhc093blByb3BlcnR5KCdyZXN1bHQnKSAmJiByZXNwb25zZS5yZXN1bHQgPT09ICdmYWlsdXJlJyApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5tZXNzYWdlcyA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oICdFcnJvciBtZXNzYWdlIGlzIGVtcHR5LicgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN3ZWRCYW5rIFBheW1lbnQgcmV0dXJucyBlcnJvciB0aGF0IE9yZGVyIHVwZGF0ZSBpcyBub3QgYXZhaWxhYmxlXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHJlc3BvbnNlLm1lc3NhZ2VzLmluZGV4T2YoICdPcmRlciB1cGRhdGUgaXMgbm90IGF2YWlsYWJsZS4nICkgPiAtMSAmJiAhIGNvbXBhdGliaWxpdHkgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2UgcmVsb2FkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCAncmVmcmVzaFBheW1lbnRNZW51OiByZWZyZXNoIHdvcmthcm91bmQuIEZvcmNlIHJlbG9hZC4nICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2Nfc2JfY2hlY2tvdXQudXBkYXRlT3JkZXIoIHRydWUgKS5kb25lKCBmdW5jdGlvbiAoIHJlc3BvbnNlICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHJlc3BvbnNlLmhhc093blByb3BlcnR5KCdqc191cmwnKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LmluaXRQYXltZW50SlMoIHJlc3BvbnNlLmpzX3VybCApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gUmVsb2FkIHBhZ2VcbiAgICAgICAgICAgICAgICAgICAgaWYgKCByZXNwb25zZS5oYXNPd25Qcm9wZXJ0eSgncmVsb2FkJykgJiYgdHJ1ZSA9PT0gcmVzcG9uc2UucmVsb2FkICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIHVwZGF0ZSBpbiBjYXNlIHdlIG5lZWQgYSBmcmVzaCBub25jZVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHRydWUgPT09IHJlc3BvbnNlLnJlc3VsdC5yZWZyZXNoICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJCggZG9jdW1lbnQuYm9keSApLnRyaWdnZXIoICd1cGRhdGVfY2hlY2tvdXQnICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB3Y19zYl9jb21tb24ubG9nRXJyb3IoICdzYi11cGRhdGUtb3JkZXInLCByZXNwb25zZSApO1xuICAgICAgICAgICAgICAgICAgICAvL3djX3NiX2NoZWNrb3V0Lm9uRXJyb3IoIHJlc3BvbnNlLm1lc3NhZ2VzICk7XG4gICAgICAgICAgICAgICAgfSApO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuICB3Y19zYl9jaGVja291dC54aHI7XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE9uIFBheW1lbnQgTWVudSBJbnN0cnVtZW50IFNlbGVjdGVkXG4gICAgICAgICAqIEBwYXJhbSBuYW1lXG4gICAgICAgICAqIEBwYXJhbSBpbnN0cnVtZW50XG4gICAgICAgICAqL1xuICAgICAgICBvblBheW1lbnRNZW51SW5zdHJ1bWVudFNlbGVjdGVkOiBmdW5jdGlvbiAoIG5hbWUsIGluc3RydW1lbnQgKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyggJ29uUGF5bWVudE1lbnVJbnN0cnVtZW50U2VsZWN0ZWQnLCBuYW1lLCBpbnN0cnVtZW50ICk7XG4gICAgICAgICAgICAkKCBkb2N1bWVudC5ib2R5ICkudHJpZ2dlciggJ3NiX3BheW1lbnRfbWVudV9pbnN0cnVtZW50X3NlbGVjdGVkJywgW25hbWUsIGluc3RydW1lbnRdICk7XG4gICAgICAgIH0sXG4gICAgICAgIG9uRXJyb3I6IGZ1bmN0aW9uICggZGF0YSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCAnb25FcnJvcicsIGRhdGEgKTtcbiAgICAgICAgICAgIHdjX3NiX2NoZWNrb3V0LnN1Ym1pdF9lcnJvciggJzxkaXYgY2xhc3M9XCJ3b29jb21tZXJjZS1lcnJvclwiPicgKyBkYXRhICsgJzwvZGl2PicgKTtcbiAgICAgICAgfSxcbiAgICAgICAgc3VibWl0X2Vycm9yOiBmdW5jdGlvbiggZXJyb3JfbWVzc2FnZSApIHtcbiAgICAgICAgICAgICQoICcud29vY29tbWVyY2UtTm90aWNlR3JvdXAtY2hlY2tvdXQsIC53b29jb21tZXJjZS1lcnJvciwgLndvb2NvbW1lcmNlLW1lc3NhZ2UnICkucmVtb3ZlKCk7XG4gICAgICAgICAgICB3Y19zYl9jaGVja291dC5mb3JtLnByZXBlbmQoICc8ZGl2IGNsYXNzPVwid29vY29tbWVyY2UtTm90aWNlR3JvdXAgd29vY29tbWVyY2UtTm90aWNlR3JvdXAtY2hlY2tvdXRcIj4nICsgZXJyb3JfbWVzc2FnZSArICc8L2Rpdj4nICk7XG4gICAgICAgICAgICB3Y19zYl9jaGVja291dC5mb3JtLnJlbW92ZUNsYXNzKCAncHJvY2Vzc2luZycgKS51bmJsb2NrKCk7XG4gICAgICAgICAgICB3Y19zYl9jaGVja291dC5mb3JtLmZpbmQoICcuaW5wdXQtdGV4dCwgc2VsZWN0LCBpbnB1dDpjaGVja2JveCcgKS50cmlnZ2VyKCAndmFsaWRhdGUnICkuYmx1cigpO1xuICAgICAgICAgICAgd2Nfc2JfY2hlY2tvdXQuc2Nyb2xsX3RvX25vdGljZXMoKTtcbiAgICAgICAgICAgICQoIGRvY3VtZW50LmJvZHkgKS50cmlnZ2VyKCAnY2hlY2tvdXRfZXJyb3InICk7XG4gICAgICAgIH0sXG4gICAgICAgIHNjcm9sbF90b19ub3RpY2VzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGxldCBzY3JvbGxFbGVtZW50ID0gJCggJy53b29jb21tZXJjZS1Ob3RpY2VHcm91cC11cGRhdGVPcmRlclJldmlldywgLndvb2NvbW1lcmNlLU5vdGljZUdyb3VwLWNoZWNrb3V0JyApO1xuICAgICAgICAgICAgaWYgKCAhIHNjcm9sbEVsZW1lbnQubGVuZ3RoICkge1xuICAgICAgICAgICAgICAgIHNjcm9sbEVsZW1lbnQgPSAkKCAnLmZvcm0uY2hlY2tvdXQnICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICQuc2Nyb2xsX3RvX25vdGljZXMoIHNjcm9sbEVsZW1lbnQgKTtcbiAgICAgICAgfSxcbiAgICB9O1xuXG4gICAgJChkb2N1bWVudCkucmVhZHkoIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgd2Nfc2JfY2hlY2tvdXQuaW5pdCggJCggXCJmb3JtLmNoZWNrb3V0LCBmb3JtI29yZGVyX3JldmlldywgZm9ybSNhZGRfcGF5bWVudF9tZXRob2RcIiApICk7XG4gICAgfSApO1xufSk7XG5cbiJdfQ==
