{"version":3,"sources":["checkin.js"],"names":["jQuery","$","window","wc_sb_checkin","init","this","isCheckinEnabled","self","document","body","on","loadCheckIn","val","checkin","length","WC_Gateway_Swedbank_Pay_Checkin","checkin_country","event","preventDefault","showAddressFields","hideAddressFields","enabled","country","ajax","type","url","ajax_url","data","action","nonce","dataType","done","success","wc_sb_common","logError","alert","details","hasOwnProperty","payex","hostedView","consumer","close","remove","loadJs","initCheckIn","waitForLoading","err","console","warn","container","culture","style","checkInStyle","JSON","parse","onConsumerIdentified","log","onNewConsumer","onConsumerRemoved","onBillingDetailsAvailable","onAddressDetailsAvailable","onShippingDetailsAvailable","needs_shipping_address","ship_to_billing_address_only","onError","open","consumerProfileRef","always","response","message","checkout_form","find","append","isInstantCheckout","wc_sb_checkout","initCheckout","block","unblock","each","key","value","forEach","section","el","prop","closest","removeClass","change","el1","Select2","select2","fn","chosen","trigger","hide","show","ready"],"mappings":"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","file":"checkin.min.js","sourcesContent":["/* global wc_checkout_params */\njQuery( function( $ ) {\n    'use strict';\n\n    window.wc_sb_checkin = {\n        /**\n         * Initialize\n         */\n        init: function() {\n            if ( this.isCheckinEnabled() ) {\n                var self = this;\n                $( document.body ).on( 'click change', '#checkin_country', function () {\n                    self.loadCheckIn( $( this ).val() );\n                } );\n\n                // Select the first item\n                let checkin = $( '#checkin_country' );\n                if ( checkin.length > 0 ) {\n                    self.loadCheckIn( checkin.val() );\n                } else {\n                    self.loadCheckIn( WC_Gateway_Swedbank_Pay_Checkin.checkin_country );\n                }\n\n                $( document.body ).on( 'click', '#change-address-info', function ( event ) {\n                    event.preventDefault();\n\n                    // Show Address Fields\n                    self.showAddressFields();\n                } );\n\n                self.hideAddressFields();\n            }\n        },\n\n        /**\n         * Check if the Checkin is active\n         * @return {boolean}\n         */\n        isCheckinEnabled() {\n            return WC_Gateway_Swedbank_Pay_Checkin.enabled;\n        },\n\n        /**\n         * Load CheckIn\n         * @param country\n         * @returns {*}\n         */\n        loadCheckIn: function( country ) {\n            return $.ajax( {\n                type: 'POST',\n                url: WC_Gateway_Swedbank_Pay_Checkin.ajax_url,\n                data: {\n                    action: 'swedbank_pay_checkin',\n                    nonce: WC_Gateway_Swedbank_Pay_Checkin.nonce,\n                    country: country\n                },\n                dataType: 'json'\n            } ).done( function ( data ) {\n                if ( ! data.success ) {\n                    wc_sb_common.logError( 'sb-checkin-loader', data );\n                    alert( data.details );\n                    return;\n                }\n\n                // Destroy\n                if ( window.hasOwnProperty( 'payex' ) && window.payex.hasOwnProperty( 'hostedView' ) ) {\n                    if ( typeof window.payex.hostedView.consumer !== 'undefined' ) {\n                        window.payex.hostedView.consumer().close();\n                    }\n                }\n\n                // Destroy JS\n                $( \"script[src*='px.consumer.client']\" ).remove();\n                $( '#swedbank-pay-checkin iframe' ).remove();\n                wc_sb_common.loadJs( data.data, function () {\n                    wc_sb_checkin.initCheckIn();\n                } );\n            } );\n        },\n\n        /**\n         * Initialize CheckIn\n         */\n        initCheckIn: function() {\n            if ( typeof payex === 'undefined') {\n                return;\n            }\n\n            wc_sb_common.waitForLoading('payex.hostedView.consumer', function ( err ) {\n                if ( err ) {\n                    console.warn( err );\n                    return;\n                }\n\n                // Init PayEx hostedView\n                window.payex.hostedView.consumer( {\n                    container: 'swedbank-pay-checkin',\n                    culture: WC_Gateway_Swedbank_Pay_Checkin.culture,\n                    style: WC_Gateway_Swedbank_Pay_Checkin.checkInStyle ? JSON.parse( WC_Gateway_Swedbank_Pay_Checkin.checkInStyle ) : null,\n                    onConsumerIdentified: function( data ) {\n                        console.log( 'hostedView: onConsumerIdentified' );\n                        wc_sb_checkin.onConsumerIdentified( data );\n                    },\n                    onNewConsumer: function( data ) {\n                        console.log( 'hostedView: onNewConsumer' );\n                        wc_sb_checkin.onConsumerIdentified( data );\n                    },\n                    onConsumerRemoved: function( data ) {\n                        console.log( 'hostedView: onConsumerRemoved' );\n                        console.log ( data );\n                    },\n                    onBillingDetailsAvailable: function( data ) {\n                        wc_sb_checkin.onAddressDetailsAvailable( 'billing', data );\n                    },\n                    onShippingDetailsAvailable: function( data ) {\n                        if ( WC_Gateway_Swedbank_Pay_Checkin.needs_shipping_address ||\n                            WC_Gateway_Swedbank_Pay_Checkin.ship_to_billing_address_only\n                        ) {\n                            wc_sb_checkin.onAddressDetailsAvailable( 'billing', data );\n                        }\n\n                        wc_sb_checkin.onAddressDetailsAvailable( 'shipping', data );\n                    },\n                    onError: function ( data ) {\n                        wc_sb_common.logError( 'sb-checkin', data );\n                        alert( data.details );\n                    }\n                } ).open();\n            });\n        },\n\n        /**\n         * On Consumer Identified\n         * @param data\n         * @returns {*}\n         */\n        onConsumerIdentified: function ( data ) {\n            console.log( 'onConsumerIdentified', data );\n\n            return $.ajax( {\n                type: 'POST',\n                url: WC_Gateway_Swedbank_Pay_Checkin.ajax_url,\n                data: {\n                    action: 'swedbank_pay_checkout_customer_profile',\n                    nonce: WC_Gateway_Swedbank_Pay_Checkin.nonce,\n                    consumerProfileRef: data.consumerProfileRef\n                },\n                dataType: 'json'\n            } ).always( function ( response ) {\n                //\n            } ).done( function ( response) {\n                if (!response.success) {\n                    alert(response.data.message);\n                    return;\n                }\n\n                // Add the reference to the checkout form\n                let checkout_form = $( \"form.checkout, form#order_review, form#add_payment_method\" );\n                checkout_form.find( '.swedbank_pay_customer_reference' ).remove();\n                checkout_form.append( \"<input type='hidden' class='swedbank_pay_customer_reference' name='swedbank_pay_customer_reference' value='\" + data.consumerProfileRef + \"'/>\" );\n\n                // Initiate Instant Checkout if active\n                if ( wc_sb_common.isInstantCheckout() ) {\n                    wc_sb_checkout.initCheckout( data.consumerProfileRef );\n                }\n            } );\n        },\n\n        /**\n         * On Address Details Available\n         * @param type\n         * @param data\n         * @returns {*}\n         */\n        onAddressDetailsAvailable: function( type, data ) {\n            console.log( 'onAddressDetailsAvailable', type, data );\n\n            wc_sb_common.block();\n            return $.ajax( {\n                type: 'POST',\n                url: WC_Gateway_Swedbank_Pay_Checkin.ajax_url,\n                data: {\n                    action: 'swedbank_pay_checkout_get_address',\n                    nonce: WC_Gateway_Swedbank_Pay_Checkin.nonce,\n                    type: type,\n                    url: data.url\n                },\n                dataType: 'json'\n            } ).always( function () {\n                wc_sb_common.unblock();\n            } ).done( function ( response ) {\n                console.log( response );\n                if ( ! response.success ) {\n                    wc_sb_common.logError( 'sb-address-details', response );\n                    alert( response.data.message );\n                    return;\n                }\n\n                // Process address\n                let data = response.data;\n                $.each( data, function ( key, value ) {\n                    [type].forEach( function( section ) {\n                        let el = $( 'input[name=\"' + section + '_' + key + '\"]' );\n                        if ( el.length === 0 ) {\n                            return;\n                        }\n\n                        el.prop( 'readonly', false );\n                        el.closest( '.form-row' ).removeClass( 'swedbank-pay-locked' );\n                        el.val( value ).change();\n\n                        if ( key === 'country' || key === 'state' ) {\n                            let el1 = $( '#' + section + '_' + key );\n                            if ( typeof window.Select2 !== 'undefined' ) {\n                                el1.select2('val', value);\n                            } else if ( typeof $.fn.chosen !== 'undefined' ) {\n                                // Chosen\n                                el1.val( value ).trigger( 'chosen:updated' );\n                                //el1.chosen().change();\n                            } else {\n                                el1.change();\n                            }\n                        }\n                    } );\n                } );\n\n                $( document.body ).trigger( 'update_checkout' );\n            } );\n        },\n        /**\n         * Hide Address Fields on the checkout\n         */\n        hideAddressFields: function () {\n            $( '.woocommerce-billing-fields__field-wrapper, .woocommerce-shipping-fields' ).hide();\n        },\n        /**\n         * Show Address Fields on the checkout\n         */\n        showAddressFields: function () {\n            $( '.woocommerce-billing-fields__field-wrapper, .woocommerce-shipping-fields' ).show();\n        }\n    }\n\n    $( document ).ready( function () {\n        wc_sb_checkin.init( $( \"form.checkout, form#order_review, form#add_payment_method\" ) );\n    } );\n} );"]}