{"version":3,"sources":["checkin.js"],"names":["jQuery","$","window","wc_sb_checkin","customer_identified","init","this","isCheckinEnabled","self","document","body","on","loadCheckIn","val","checkin","length","WC_Gateway_Swedbank_Pay_Checkin","checkin_country","event","preventDefault","showAddressFields","hideAddressFields","enabled","[object Object]","checkin_required","country","ajax","type","url","ajax_url","data","action","nonce","dataType","done","success","wc_sb_common","logError","alert","details","hasOwnProperty","payex","loadJs","initCheckIn","waitForLoading","err","console","warn","hostedView","consumer","container","culture","style","checkInStyle","JSON","parse","onConsumerIdentified","log","onNewConsumer","onConsumerRemoved","onBillingDetailsAvailable","onAddressDetailsAvailable","onShippingDetailsAvailable","needs_shipping_address","ship_to_billing_address_only","onError","open","consumerProfileRef","always","response","message","show","checkout_form","find","remove","append","isInstantCheckout","wc_sb_checkout","initCheckout","block","unblock","each","key","value","forEach","section","el","prop","closest","removeClass","change","el1","Select2","select2","fn","chosen","trigger","hide","ready"],"mappings":"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","file":"checkin.min.js","sourcesContent":["/* global wc_checkout_params */\njQuery( function( $ ) {\n    'use strict';\n\n    window.wc_sb_checkin = {\n        customer_identified: false,\n\n        /**\n         * Initialize\n         */\n        init: function() {\n            if ( this.isCheckinEnabled() ) {\n                var self = this;\n                $( document.body ).on( 'click change', '#checkin_country', function () {\n                    self.loadCheckIn( $( this ).val() );\n                } );\n\n                // Select the first item\n                let checkin = $( '#checkin_country' );\n                if ( checkin.length > 0 ) {\n                    self.loadCheckIn( checkin.val() );\n                } else {\n                    self.loadCheckIn( WC_Gateway_Swedbank_Pay_Checkin.checkin_country );\n                }\n\n                $( document.body ).on( 'click', '#change-address-info', function ( event ) {\n                    event.preventDefault();\n\n                    // Show Address Fields\n                    self.showAddressFields();\n                } );\n\n                self.hideAddressFields();\n            }\n        },\n\n        /**\n         * Check if the Checkin is active\n         * @return {boolean}\n         */\n        isCheckinEnabled() {\n            return 'yes' === WC_Gateway_Swedbank_Pay_Checkin.enabled;\n        },\n\n        /**\n         * Check if the Checkin is required\n         * @return {boolean}\n         */\n        isCheckinRequired() {\n            return this.isCheckinEnabled() && 'yes' === WC_Gateway_Swedbank_Pay_Checkin.checkin_required;\n        },\n\n        /**\n         * Check if customer was identified\n         * @return {boolean}\n         */\n        isCustomerIdentified() {\n            return this.customer_identified === true;\n        },\n\n        /**\n         * Load CheckIn\n         * @param country\n         * @returns {*}\n         */\n        loadCheckIn: function( country ) {\n            return $.ajax( {\n                type: 'POST',\n                url: WC_Gateway_Swedbank_Pay_Checkin.ajax_url,\n                data: {\n                    action: 'swedbank_pay_checkin',\n                    nonce: WC_Gateway_Swedbank_Pay_Checkin.nonce,\n                    country: country\n                },\n                dataType: 'json'\n            } ).done( function ( data ) {\n                if ( ! data.success ) {\n                    wc_sb_common.logError( 'sb-checkin-loader', data );\n                    alert( data.details );\n                    return;\n                }\n\n                // Destroy\n                if ( window.hasOwnProperty( 'payex' ) && window.payex.hasOwnProperty( 'hostedView' ) ) {\n                    //if ( typeof window.payex.hostedView.consumer !== 'undefined' ) {\n                        //window.payex.hostedView.consumer().close();\n                    //}\n                }\n\n                // Destroy JS\n                //$( \"script[src*='px.consumer.client']\" ).remove();\n                //$( '#swedbank-pay-checkin iframe' ).remove();\n                wc_sb_common.loadJs( data.data, function () {\n                    wc_sb_checkin.initCheckIn();\n                } );\n            } );\n        },\n\n        /**\n         * Initialize CheckIn\n         */\n        initCheckIn: function() {\n            if ( typeof payex === 'undefined') {\n                return;\n            }\n\n            wc_sb_common.waitForLoading('payex.hostedView.consumer', function ( err ) {\n                if ( err ) {\n                    console.warn( err );\n                    return;\n                }\n\n                // Init PayEx hostedView\n                window.payex.hostedView.consumer( {\n                    container: 'swedbank-pay-checkin',\n                    culture: WC_Gateway_Swedbank_Pay_Checkin.culture,\n                    style: WC_Gateway_Swedbank_Pay_Checkin.checkInStyle ? JSON.parse( WC_Gateway_Swedbank_Pay_Checkin.checkInStyle ) : null,\n                    onConsumerIdentified: function( data ) {\n                        console.log( 'hostedView: onConsumerIdentified' );\n                        wc_sb_checkin.onConsumerIdentified( data );\n                    },\n                    onNewConsumer: function( data ) {\n                        console.log( 'hostedView: onNewConsumer' );\n                        wc_sb_checkin.onConsumerIdentified( data );\n                    },\n                    onConsumerRemoved: function( data ) {\n                        console.log( 'hostedView: onConsumerRemoved' );\n                        console.log ( data );\n                    },\n                    onBillingDetailsAvailable: function( data ) {\n                        wc_sb_checkin.onAddressDetailsAvailable( 'billing', data );\n                    },\n                    onShippingDetailsAvailable: function( data ) {\n                        if ( WC_Gateway_Swedbank_Pay_Checkin.needs_shipping_address ||\n                            WC_Gateway_Swedbank_Pay_Checkin.ship_to_billing_address_only\n                        ) {\n                            wc_sb_checkin.onAddressDetailsAvailable( 'billing', data );\n                        }\n\n                        wc_sb_checkin.onAddressDetailsAvailable( 'shipping', data );\n                    },\n                    onError: function ( data ) {\n                        wc_sb_common.logError( 'sb-checkin', data );\n                        alert( data.details );\n                    }\n                } ).open();\n            });\n        },\n\n        /**\n         * On Consumer Identified\n         * @param data\n         * @returns {*}\n         */\n        onConsumerIdentified: function ( data ) {\n            console.log( 'onConsumerIdentified', data );\n\n            var self = this;\n\n            return $.ajax( {\n                type: 'POST',\n                url: WC_Gateway_Swedbank_Pay_Checkin.ajax_url,\n                data: {\n                    action: 'swedbank_pay_checkout_customer_profile',\n                    nonce: WC_Gateway_Swedbank_Pay_Checkin.nonce,\n                    consumerProfileRef: data.consumerProfileRef\n                },\n                dataType: 'json'\n            } ).always( function ( response ) {\n                //\n            } ).done( function ( response) {\n                if (!response.success) {\n                    alert(response.data.message);\n                    return;\n                }\n\n                self.customer_identified = true;\n\n                // Show button witch allows to edit the address\n                $('#swedbank-pay-checkin-edit').show();\n\n                // Add the reference to the checkout form\n                let checkout_form = $( \"form.checkout, form#order_review, form#add_payment_method\" );\n                checkout_form.find( '.swedbank_pay_customer_reference' ).remove();\n                checkout_form.append( \"<input type='hidden' class='swedbank_pay_customer_reference' name='swedbank_pay_customer_reference' value='\" + data.consumerProfileRef + \"'/>\" );\n\n                // Initiate Instant Checkout if active\n                if ( wc_sb_common.isInstantCheckout() ) {\n                    wc_sb_checkout.initCheckout( data.consumerProfileRef );\n                }\n            } );\n        },\n\n        /**\n         * On Address Details Available\n         * @param type\n         * @param data\n         * @returns {*}\n         */\n        onAddressDetailsAvailable: function( type, data ) {\n            console.log( 'onAddressDetailsAvailable', type, data );\n\n            wc_sb_common.block();\n            return $.ajax( {\n                type: 'POST',\n                url: WC_Gateway_Swedbank_Pay_Checkin.ajax_url,\n                data: {\n                    action: 'swedbank_pay_checkout_get_address',\n                    nonce: WC_Gateway_Swedbank_Pay_Checkin.nonce,\n                    type: type,\n                    url: data.url\n                },\n                dataType: 'json'\n            } ).always( function () {\n                wc_sb_common.unblock();\n            } ).done( function ( response ) {\n                console.log( response );\n                if ( ! response.success ) {\n                    wc_sb_common.logError( 'sb-address-details', response );\n                    alert( response.data.message );\n                    return;\n                }\n\n                // Process address\n                let data = response.data;\n                $.each( data, function ( key, value ) {\n                    [type].forEach( function( section ) {\n                        let el = $( 'input[name=\"' + section + '_' + key + '\"]' );\n                        if ( el.length === 0 ) {\n                            return;\n                        }\n\n                        el.prop( 'readonly', false );\n                        el.closest( '.form-row' ).removeClass( 'swedbank-pay-locked' );\n                        el.val( value ).change();\n\n                        if ( key === 'country' || key === 'state' ) {\n                            let el1 = $( '#' + section + '_' + key );\n                            if ( typeof window.Select2 !== 'undefined' ) {\n                                el1.select2('val', value);\n                            } else if ( typeof $.fn.chosen !== 'undefined' ) {\n                                // Chosen\n                                el1.val( value ).trigger( 'chosen:updated' );\n                                //el1.chosen().change();\n                            } else {\n                                el1.change();\n                            }\n                        }\n                    } );\n                } );\n\n                $( document.body ).trigger( 'update_checkout' );\n            } );\n        },\n        /**\n         * Hide Address Fields on the checkout\n         */\n        hideAddressFields: function () {\n            $( '.woocommerce-billing-fields__field-wrapper, .woocommerce-shipping-fields' ).hide();\n        },\n        /**\n         * Show Address Fields on the checkout\n         */\n        showAddressFields: function () {\n            $( '.woocommerce-billing-fields__field-wrapper, .woocommerce-shipping-fields' ).show();\n        }\n    }\n\n    $( document ).ready( function () {\n        wc_sb_checkin.init( $( \"form.checkout, form#order_review, form#add_payment_method\" ) );\n    } );\n} );"]}